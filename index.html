<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitura de Partitura</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        
        .canvas-container {
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            touch-action: pan-x;
        }
        
        #canvas {
            display: block;
            min-width: 1000px;
            background: white;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
        }
        
        .settings {
            background: #f8f9fa;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .settings h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .setting-group {
            display: inline-block;
            margin: 10px;
            vertical-align: top;
            min-width: 120px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }
        
        button {
            padding: 12px 24px;
            font-size: clamp(14px, 3vw, 16px);
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            min-height: 44px;
            min-width: 80px;
            touch-action: manipulation;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:active {
            background: #004085;
            transform: scale(0.98);
        }
        
        input, select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: clamp(14px, 2.5vw, 16px);
            min-height: 44px;
            width: 100%;
            box-sizing: border-box;
        }
        
        input[type="range"] {
            width: 100%;
            min-width: 120px;
        }
        
        input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .bpm-display {
            font-weight: bold;
            color: #007bff;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .settings {
                text-align: center;
            }
            
            .setting-group {
                display: block;
                margin: 15px auto;
                max-width: 250px;
            }
            
            #canvas {
                min-width: 800px;
            }
        }
        
        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
            }
            
            button {
                margin: 5px 0;
                width: 100%;
                max-width: 200px;
            }
            
            #canvas {
                min-width: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Treinamento de Leitura de Partitura</h1>
        <div class="canvas-container">
            <canvas id="canvas" width="1000" height="400"></canvas>
        </div>
        <div class="controls">
            <button id="playBtn">Play</button>
            <button id="stopBtn">Stop</button>
        </div>
        
        <div class="settings">
            <h3>Configurações</h3>
            <div class="setting-group">
                <label for="bpmSlider">BPM: <span id="bpmValue" class="bpm-display">120</span></label>
                <input type="range" id="bpmSlider" min="60" max="180" value="120">
            </div>
            
            <div class="setting-group">
                <label for="difficultySelect">Dificuldade:</label>
                <select id="difficultySelect">
                    <option value="muito-facil">Muito Fácil</option>
                    <option value="facil">Fácil</option>
                    <option value="iniciante" selected>Iniciante</option>
                    <option value="basico">Básico</option>
                    <option value="intermediario">Intermediário</option>
                    <option value="avancado">Avançado</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label for="scaleSelect">Escala:</label>
                <select id="scaleSelect">
                    <option value="c-major">Dó Maior</option>
                    <option value="g-major">Sol Maior</option>
                    <option value="f-major">Fá Maior</option>
                    <option value="d-major">Ré Maior</option>
                </select>
            </div>
            
            <div class="setting-group">
                <label>
                    <input type="checkbox" id="manualRange"> Range Manual
                </label>
                <select id="rangeSelect" disabled>
                    <option value="basic">Básico (Dó3-Dó5)</option>
                    <option value="extended">Estendido (Lá2-Fá5)</option>
                    <option value="full">Completo (Sol2-Sol5)</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Função para desenhar clave de Sol usando símbolo Unicode
        function drawTrebleClef(x, y) {
            ctx.fillStyle = '#000';
            ctx.font = '48px serif';
            ctx.textAlign = 'center';
            ctx.fillText('𝄞', x + 15, y + 10);
        }
        
        // Função para desenhar clave de Fá usando símbolo Unicode
        function drawBassClef(x, y) {
            ctx.fillStyle = '#000';
            ctx.font = '40px serif';
            ctx.textAlign = 'center';
            ctx.fillText('𝄢', x + 15, y + 8);
        }
        
        // Função para desenhar linhas suplementares
        function drawLedgerLines(x, y, clef) {
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            
            if (clef === 'treble') {
                const trebleY = 80;
                // Linhas suplementares superiores (acima da pauta)
                if (y <= trebleY - 12) {
                    for (let lineY = trebleY - 12; lineY >= y; lineY -= 12) {
                        ctx.beginPath();
                        ctx.moveTo(x - 8, lineY);
                        ctx.lineTo(x + 8, lineY);
                        ctx.stroke();
                    }
                }
                // Linhas suplementares inferiores (abaixo da pauta)
                if (y >= trebleY + 60) {
                    for (let lineY = trebleY + 60; lineY <= y; lineY += 12) {
                        ctx.beginPath();
                        ctx.moveTo(x - 8, lineY);
                        ctx.lineTo(x + 8, lineY);
                        ctx.stroke();
                    }
                }
            } else if (clef === 'bass') {
                const bassY = 220;
                // Linhas suplementares superiores (acima da pauta)
                if (y <= bassY - 12) {
                    for (let lineY = bassY - 12; lineY >= y; lineY -= 12) {
                        ctx.beginPath();
                        ctx.moveTo(x - 8, lineY);
                        ctx.lineTo(x + 8, lineY);
                        ctx.stroke();
                    }
                }
                // Linhas suplementares inferiores (abaixo da pauta)
                if (y >= bassY + 60) {
                    for (let lineY = bassY + 60; lineY <= y; lineY += 12) {
                        ctx.beginPath();
                        ctx.moveTo(x - 8, lineY);
                        ctx.lineTo(x + 8, lineY);
                        ctx.stroke();
                    }
                }
            }
        }
        
        // Função para desenhar uma nota
        function drawNote(x, y, noteType = 'semínima', clef = 'treble') {
            // Desenhar linhas suplementares primeiro
            drawLedgerLines(x, y, clef);
            
            ctx.fillStyle = '#000';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1.5;
            
            // Cabeça da nota
            ctx.beginPath();
            ctx.ellipse(x, y, 5, 4, 0.3, 0, 2 * Math.PI);
            
            if (noteType === 'semibreve') {
                // Semibreve: cabeça vazada, sem haste
                ctx.stroke();
            } else if (noteType === 'mínima') {
                // Mínima: cabeça vazada com haste
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x + 5, y);
                ctx.lineTo(x + 5, y - 30);
                ctx.stroke();
            } else {
                // Semínima e colcheia: cabeça preenchida
                ctx.fill();
                
                // Haste para semínima e colcheia
                if (noteType === 'semínima' || noteType === 'colcheia') {
                    ctx.beginPath();
                    ctx.moveTo(x + 5, y);
                    ctx.lineTo(x + 5, y - 30);
                    ctx.stroke();
                }
                
                // Bandeirola para colcheia
                if (noteType === 'colcheia') {
                    ctx.beginPath();
                    ctx.moveTo(x + 5, y - 30);
                    ctx.quadraticCurveTo(x + 15, y - 25, x + 12, y - 15);
                    ctx.fill();
                }
            }
        }
        
        // Função para desenhar pausas
        function drawRest(x, y, restType = 'semínima') {
            ctx.fillStyle = '#000';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.font = '20px serif';
            ctx.textAlign = 'center';
            
            switch(restType) {
                case 'semibreve':
                    // Pausa de semibreve: retângulo pendurado na linha
                    ctx.fillRect(x - 6, y - 9, 12, 4);
                    break;
                case 'mínima':
                    // Pausa de mínima: retângulo em cima da linha
                    ctx.fillRect(x - 6, y + 1, 12, 4);
                    break;
                case 'semínima':
                    // Pausa de semínima: símbolo específico
                    ctx.fillText('𝄽', x, y + 5);
                    break;
                case 'colcheia':
                    // Pausa de colcheia: símbolo específico
                    ctx.fillText('𝄾', x, y + 5);
                    break;
            }
        }
        
        // Função para desenhar as linhas da pauta e claves
        function drawStaff() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            
            // Clave de Sol (pauta superior)
            const trebleY = 80;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(80, trebleY + i * 12);
                ctx.lineTo(950, trebleY + i * 12);
                ctx.stroke();
            }
            
            // Desenhar clave de Sol
            drawTrebleClef(50, trebleY + 24);
            
            // Clave de Fá (pauta inferior)
            const bassY = 220;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(80, bassY + i * 12);
                ctx.lineTo(950, bassY + i * 12);
                ctx.stroke();
            }
            
            // Desenhar clave de Fá
            drawBassClef(50, bassY + 12);
            
            // Gerar notas proceduralmente
            generateMeasures();
        }
        
        // Variáveis de controle do playback
        let isPlaying = false;
        let playbackPosition = 100; // Posição inicial em pixels
        let bpm = 120; // BPM padrão
        let animationId = null;
        let currentMeasure = 0;
        let measuresData = []; // Array para armazenar os compassos gerados
        
        // Variáveis para mobile/touch
        let scale = 1;
        let canvasContainer = null;
        
        // Configurações de geração musical
        let currentScale = 'c-major';
        let currentDifficulty = 'iniciante';
        let currentRange = 'basic';
        let useManualRange = false;
        
        // Escalas musicais (em semitons relativos a Dó)
        const scales = {
            'c-major': [0, 2, 4, 5, 7, 9, 11], // Dó, Ré, Mi, Fá, Sol, Lá, Si
            'g-major': [7, 9, 11, 0, 2, 4, 6], // Sol, Lá, Si, Dó, Ré, Mi, Fá#
            'f-major': [5, 7, 9, 10, 0, 2, 4], // Fá, Sol, Lá, Sib, Dó, Ré, Mi
            'd-major': [2, 4, 6, 7, 9, 11, 1]  // Ré, Mi, Fá#, Sol, Lá, Si, Dó#
        };
        
        // Ranges de notas por dificuldade (posições Y na pauta)
        const difficultyNoteRanges = {
            'muito-facil': {
                treble: [48, 42], // Apenas Mi e Fá (fáceis de ler)
                bass: [6, 0]      // Apenas Sol e Lá
            },
            'facil': {
                treble: [54, 48, 42], // Ré, Mi, Fá
                bass: [12, 6, 0]      // Sol, Lá, Si
            },
            'iniciante': {
                treble: [60, 54, 48, 42, 36], // Dó a Sol
                bass: [18, 12, 6, 0, -6]      // Fá a Ré
            },
            'basico': {
                treble: [66, 60, 54, 48, 42, 36, 30], // Si a Lá
                bass: [24, 18, 12, 6, 0, -6, -12]     // Si a Mi
            },
            'intermediario': {
                treble: [72, 66, 60, 54, 48, 42, 36, 30], // Lá a Lá (oitava)
                bass: [30, 24, 18, 12, 6, 0, -6, -12]     // Dó a Mi
            },
            'avancado': {
                treble: [78, 72, 66, 60, 54, 48, 42, 36, 30, 24], // Sol a Si (amplo)
                bass: [36, 30, 24, 18, 12, 6, 0, -6, -12, -18]     // Sol a Sol (amplo)
            }
        };
        
        // Ranges de notas (posições Y na pauta) - mantido para compatibilidade
        const noteRanges = {
            'basic': difficultyNoteRanges['iniciante'],
            'extended': difficultyNoteRanges['intermediario'],
            'full': difficultyNoteRanges['avancado']
        };
        
        // Gerador de notas procedurais
        class MusicGenerator {
            constructor() {
                this.lastNote = { treble: 48, bass: 6 }; // Mi e Sol como notas iniciais
                this.phrasePosition = 0;
                this.measureCount = 0;
            }
            
            generateNote(clef) {
                // Usar range baseado na dificuldade ou configuração manual
                const range = useManualRange ? 
                    noteRanges[currentRange][clef] : 
                    difficultyNoteRanges[currentDifficulty][clef];
                const scale = scales[currentScale];
                let targetNote;
                
                // Diferentes estratégias por dificuldade
                const difficultyStrategies = {
                    'muito-facil': 0.9, // 90% movimento conjunto
                    'facil': 0.8,       // 80% movimento conjunto
                    'iniciante': 0.7,   // 70% movimento conjunto
                    'basico': 0.6,      // 60% movimento conjunto
                    'intermediario': 0.5, // 50% movimento conjunto
                    'avancado': 0.4     // 40% movimento conjunto (mais saltos)
                };
                
                const conjunctMovement = difficultyStrategies[currentDifficulty] || 0.7;
                
                // Lógica de movimento melódico baseada na dificuldade
                if (Math.random() < conjunctMovement) {
                    // Movimento por grau conjunto
                    const direction = Math.random() < 0.5 ? -1 : 1;
                    const currentIndex = range.indexOf(this.lastNote[clef]);
                    const newIndex = Math.max(0, Math.min(range.length - 1, currentIndex + direction));
                    targetNote = range[newIndex];
                } else {
                    // Saltos - tamanho varia por dificuldade
                    const maxJump = currentDifficulty === 'avancado' ? 5 : 3;
                    const currentIndex = range.indexOf(this.lastNote[clef]);
                    const jump = (Math.floor(Math.random() * maxJump) + 1) * (Math.random() < 0.5 ? -1 : 1);
                    const newIndex = Math.max(0, Math.min(range.length - 1, currentIndex + jump));
                    targetNote = range[newIndex];
                }
                
                this.lastNote[clef] = targetNote;
                return targetNote;
            }
            
            generateMeasure() {
                // Gerar dados separados para cada clave
                const trebleBeats = this.generateClefMeasure('treble');
                const bassBeats = this.generateClefMeasure('bass');
                
                return { treble: trebleBeats, bass: bassBeats };
            }
            
            generateClefMeasure(clef) {
                const beats = [];
                let totalBeats = 0;
                const targetBeats = 4; // Compasso 4/4
                
                // Valores rítmicos em tempos
                const rhythmValues = {
                    'semibreve': 4,
                    'mínima': 2,
                    'semínima': 1,
                    'colcheia': 0.5,
                    'pausa-semibreve': 4,
                    'pausa-mínima': 2,
                    'pausa-semínima': 1,
                    'pausa-colcheia': 0.5
                };
                
                const difficultyRhythms = {
                    'muito-facil': ['semibreve', 'mínima'], // Apenas notas longas
                    'facil': ['mínima', 'semínima', 'pausa-mínima'], // Ritmos simples
                    'iniciante': ['semínima', 'mínima', 'pausa-semínima'], // Mais semínimas
                    'basico': ['semínima', 'mínima', 'colcheia', 'pausa-semínima', 'pausa-colcheia'], // Introduz colcheias
                    'intermediario': ['semínima', 'mínima', 'colcheia', 'semibreve', 'pausa-colcheia'], // Mais variedade
                    'avancado': ['semínima', 'mínima', 'colcheia', 'semibreve', 'pausa-colcheia', 'pausa-mínima'] // Complexo
                };
                
                const availableRhythms = difficultyRhythms[currentDifficulty];
                
                while (totalBeats < targetBeats) {
                    const remainingBeats = targetBeats - totalBeats;
                    const possibleRhythms = availableRhythms.filter(rhythm => 
                        rhythmValues[rhythm] <= remainingBeats
                    );
                    
                    if (possibleRhythms.length === 0) {
                        // Preencher com pausas se necessário
                        beats.push({
                            type: 'rest',
                            rhythm: remainingBeats >= 1 ? 'pausa-semínima' : 'pausa-colcheia',
                            duration: remainingBeats >= 1 ? 1 : 0.5,
                            position: totalBeats
                        });
                        totalBeats = targetBeats;
                    } else {
                        const selectedRhythm = possibleRhythms[Math.floor(Math.random() * possibleRhythms.length)];
                        const duration = rhythmValues[selectedRhythm];
                        
                        if (selectedRhythm.startsWith('pausa-')) {
                            beats.push({
                                type: 'rest',
                                rhythm: selectedRhythm.replace('pausa-', ''),
                                duration: duration,
                                position: totalBeats
                            });
                        } else {
                            beats.push({
                                type: 'note',
                                rhythm: selectedRhythm,
                                duration: duration,
                                pitch: this.generateNote(clef),
                                position: totalBeats
                            });
                        }
                        totalBeats += duration;
                    }
                }
                
                return beats;
            }
        }
        
        const musicGen = new MusicGenerator();
        
        // Função para inicializar compassos
        function initializeMeasures() {
            measuresData = [];
            for (let i = 0; i < 4; i++) {
                measuresData.push(musicGen.generateMeasure());
            }
        }
        
        // Função para desenhar compassos baseado nos dados armazenados
        function drawMeasures() {
            const trebleY = 80;
            const bassY = 220;
            const measureWidth = 200;
            const baseX = 120;
            const beatWidth = measureWidth / 4; // Cada tempo ocupa 1/4 do compasso
            
            for (let measureIndex = 0; measureIndex < 4; measureIndex++) {
                const measureX = baseX + (measureIndex * measureWidth);
                const measureData = measuresData[measureIndex];
                
                // Desenhar clave de Sol
                const trebleBeats = measureData.treble;
                for (let beatIndex = 0; beatIndex < trebleBeats.length; beatIndex++) {
                    const beat = trebleBeats[beatIndex];
                    const noteX = measureX + (beat.position * beatWidth); // Posição baseada no tempo musical
                    
                    if (beat.type === 'rest') {
                        drawRest(noteX, trebleY + 24, beat.rhythm);
                    } else {
                        drawNote(noteX, trebleY + beat.pitch, beat.rhythm, 'treble');
                    }
                }
                
                // Desenhar clave de Fá
                const bassBeats = measureData.bass;
                for (let beatIndex = 0; beatIndex < bassBeats.length; beatIndex++) {
                    const beat = bassBeats[beatIndex];
                    const noteX = measureX + (beat.position * beatWidth); // Posição baseada no tempo musical
                    
                    if (beat.type === 'rest') {
                        drawRest(noteX, bassY + 12, beat.rhythm);
                    } else {
                        drawNote(noteX, bassY + beat.pitch, beat.rhythm, 'bass');
                    }
                }
                
                // Desenhar barra de compasso
                if (measureIndex < 3) {
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(measureX + measureWidth - 20, trebleY);
                    ctx.lineTo(measureX + measureWidth - 20, bassY + 48);
                    ctx.stroke();
                }
            }
        }
        
        // Função para gerar compassos de música
        function generateMeasures() {
            if (measuresData.length === 0) {
                initializeMeasures();
            }
            drawMeasures();
        }
        
        // Função para desenhar linha indicadora de posição
        function drawPlaybackLine(x) {
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, 60);
            ctx.lineTo(x, 320);
            ctx.stroke();
        }
        
        // Função para redesenhar tudo
        function redraw() {
            drawStaff();
            if (isPlaying) {
                drawPlaybackLine(playbackPosition);
            }
        }
        
        // Função de animação do playback
        function animate() {
            if (!isPlaying) return;
            
            // Calcular velocidade baseada no BPM
            const speed = (bpm / 120) * 1;
            playbackPosition += speed;
            
            // Verificar mudança de compasso (cada compasso tem 200px de largura)
            const measureWidth = 200;
            const newMeasure = Math.floor((playbackPosition - 120) / measureWidth);
            
            if (newMeasure !== currentMeasure && newMeasure >= 0) {
                currentMeasure = newMeasure;
                
                // Quando passa para um novo compasso, regenerar o compasso mais antigo
                if (currentMeasure > 0) {
                    const oldestMeasureIndex = (currentMeasure - 1) % 4;
                    measuresData[oldestMeasureIndex] = musicGen.generateMeasure();
                }
            }
            
            // Reiniciar quando chegar ao final (4 compassos)
            if (playbackPosition > 120 + (4 * measureWidth)) {
                playbackPosition = 120;
                currentMeasure = 0;
            }
            
            redraw();
            animationId = requestAnimationFrame(animate);
        }
        
        // Inicialização
        function initializeApp() {
            canvasContainer = document.querySelector('.canvas-container');
            
            // Detectar dispositivo móvel
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Ajustar canvas para mobile
                canvas.width = Math.max(600, window.innerWidth - 40);
                canvas.height = 300;
                
                // Adicionar suporte a pinch-to-zoom
                let lastTouchDistance = 0;
                
                canvasContainer.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 2) {
                        lastTouchDistance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                    }
                }, { passive: true });
                
                canvasContainer.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 2) {
                        const currentDistance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        
                        if (lastTouchDistance > 0) {
                            const ratio = currentDistance / lastTouchDistance;
                            scale = Math.max(0.5, Math.min(3, scale * ratio));
                            
                            canvas.style.transform = `scale(${scale})`;
                            canvas.style.transformOrigin = 'top left';
                        }
                        
                        lastTouchDistance = currentDistance;
                    }
                }, { passive: true });
                
                canvasContainer.addEventListener('touchend', function(e) {
                    if (e.touches.length < 2) {
                        lastTouchDistance = 0;
                    }
                }, { passive: true });
            }
            
            // Responsividade para mudanças de orientação
            window.addEventListener('resize', function() {
                if (isMobile) {
                    canvas.width = Math.max(600, window.innerWidth - 40);
                    setTimeout(redraw, 100);
                }
            });
            
            // Desenhar a partitura inicial
            redraw();
        }
        
        // Inicializar quando a página carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Event listeners
        document.getElementById('playBtn').addEventListener('click', function() {
            if (!isPlaying) {
                isPlaying = true;
                this.textContent = 'Pause';
                animate();
            } else {
                isPlaying = false;
                this.textContent = 'Play';
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                redraw(); // Remove a linha vermelha
            }
        });
        
        document.getElementById('stopBtn').addEventListener('click', function() {
            isPlaying = false;
            playbackPosition = 120; // Reset posição
            currentMeasure = 0; // Reset compasso atual
            document.getElementById('playBtn').textContent = 'Play';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            redraw();
        });
        
        // Event listeners para configurações
        document.getElementById('bpmSlider').addEventListener('input', function() {
            bpm = parseInt(this.value);
            document.getElementById('bpmValue').textContent = bpm;
        });
        
        document.getElementById('difficultySelect').addEventListener('change', function() {
            currentDifficulty = this.value;
            musicGen.lastNote = { treble: 48, bass: 6 }; // Reset posição
            measuresData = []; // Forçar regeneração de todos os compassos
            redraw();
        });
        
        document.getElementById('scaleSelect').addEventListener('change', function() {
            currentScale = this.value;
            musicGen.lastNote = { treble: 48, bass: 6 }; // Reset posição
            measuresData = []; // Forçar regeneração de todos os compassos
            redraw();
        });
        
        document.getElementById('manualRange').addEventListener('change', function() {
            useManualRange = this.checked;
            document.getElementById('rangeSelect').disabled = !this.checked;
            musicGen.lastNote = { treble: 48, bass: 6 }; // Reset posição
            measuresData = []; // Forçar regeneração de todos os compassos
            redraw();
        });
        
        document.getElementById('rangeSelect').addEventListener('change', function() {
            if (useManualRange) {
                currentRange = this.value;
                musicGen.lastNote = { treble: 48, bass: 6 }; // Reset posição
                measuresData = []; // Forçar regeneração de todos os compassos
                redraw();
            }
        });
    </script>
</body>
</html>
